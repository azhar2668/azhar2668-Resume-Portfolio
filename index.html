#!/bin/bash

# Variables
JENKINS_HOME="/var/lib/jenkins"
BACKUP_DIR=~/backups/jenkins  # Ensure this directory is writable
REMOTE_USER="ubuntu"
REMOTE_HOST="172.31.10.138"
REMOTE_DIR="/home/ubuntu/jenkins_backup"

DATE=$(date +"%Y%m%d%H%M%S")
BACKUP_FILE="jenkins_backup_$DATE.tar.gz"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Function to create a backup
create_backup() {
    echo "Creating backup..."
    tar -czf "$BACKUP_DIR/$BACKUP_FILE" "$JENKINS_HOME"
    if [ $? -eq 0 ]; then
        echo "Backup created successfully at $BACKUP_DIR/$BACKUP_FILE"

        # Copy to remote EC2
        echo "Transferring backup to remote server..."
        scp "$BACKUP_DIR/$BACKUP_FILE" "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR"
        if [ $? -eq 0 ]; then
            echo "Backup and transfer completed successfully."
        else
            echo "Backup transfer failed."
        fi
    else
        echo "Backup failed."
    fi
}

# Function to restore a backup
restore_backup() {
    echo "Available backups:"
    ls "$BACKUP_DIR" | grep "jenkins_backup_"

    echo -n "Enter the date of the backup you want to restore (format: YYYYMMDDHHMMSS): "
    read restore_date

    RESTORE_FILE="jenkins_backup_$restore_date.tar.gz"

    if [ -f "$BACKUP_DIR/$RESTORE_FILE" ]; then
        echo "Restoring backup $RESTORE_FILE..."
        tar -xzf "$BACKUP_DIR/$RESTORE_FILE" -C "$JENKINS_HOME"
        if [ $? -eq 0 ]; then
            echo "Restore completed successfully."
        else
            echo "Restore failed."
        fi
    else
        echo "Backup file $RESTORE_FILE not found in $BACKUP_DIR."
    fi
}

# Main menu
echo "What would you like to do?"
echo "1. Create a backup"
echo "2. Restore a backup"
echo -n "Enter your choice (1 or 2): "
read choice

case $choice in
    1)
        create_backup
        ;;
    2)
        restore_backup
        ;;
    *)
        echo "Invalid choice. Exiting."
        exit 1
        ;;
esac
